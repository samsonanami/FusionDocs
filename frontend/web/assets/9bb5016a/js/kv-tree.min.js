/*!
 * @copyright Copyright &copy; Kartik Visweswaran, Krajee.com, 2015 - 2018
 * @package yii2-tree-manager
 * @version 1.0.9
 * 
 * Tree View Validation Module.
 *
 * Author: Kartik Visweswaran
 * Copyright: 2015 - 2018, Kartik Visweswaran, Krajee.com
 * For more JQuery plugins visit http://plugins.krajee.com
 * For more Yii related demos visit http://demos.krajee.com
 */!function(e){"use strict";var t,a,i;t={QUERY_PARAM:"kvtree",DEFAULT_BUTTONS:{create:"create",createR:"create-root",trash:"remove",moveU:"move-up",moveD:"move-down",moveL:"move-left",moveR:"move-right",refresh:"refresh"},isEmpty:function(t,a){return null==t||0===t.length||a&&""===e.trim(t)},escapeRegExp:function(e){return e.replace(/[\-\[\]\/\{}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},getAjaxData:function(t){var a={};return a[yii.getCsrfParam()||"_csrf"]=yii.getCsrfToken(),e.extend(!0,{},t,a)},addCss:function(e,t){e.removeClass(t).addClass(t)},hashString:function(e){return e.split("").reduce(function(e,t){return(e=(e<<5)-e+t.charCodeAt(0))&e},0)},delay:(i=0,function(e,t){clearTimeout(i),i=setTimeout(e,t)})},(a=function(t,a){this.$element=e(t),this.init(a),this.listen()}).prototype={constructor:a,init:function(a){var i,s=this;s.initCache(),e.each(a,function(e,t){s[e]=t}),s.dialogLib=window[s.dialogLib]||"",s.btns=e.extend({},t.DEFAULT_BUTTONS,s.btns),s.$tree=e("#"+s.treeId),s.$treeContainer=s.$tree.closest(".kv-tree-wrapper"),s.$detail=e("#"+s.detailId),s.$toolbar=e("#"+s.toolbarId),s.$wrapper=e("#"+s.wrapperId),s.$searchContainer=s.$wrapper.find(".kv-search-container"),s.$search=s.$wrapper.find(".kv-search-input"),s.$clear=s.$wrapper.find(".kv-search-clear"),i=s.$detail.find("form"),s.treeManageHash=i.find('input[name="treeManageHash"]').val(),s.treeRemoveHash=i.find('input[name="treeRemoveHash"]').val(),s.treeMoveHash=i.find('input[name="treeMoveHash"]').val(),s.select(s.$element.data("key"),!0),s.treeCache.timeout=s.cacheTimeout,s.hasActiveFilter=!1,s.selectNodes(),s.validateTooltips()},initCache:function(){var t=this;t.treeCache={timeout:3e5,data:{},remove:function(e){delete t.treeCache.data[e]},exist:function(e){var a=t.treeCache;return!!a.data[e]&&(new Date).getTime()-a.data[e]._<a.timeout},get:function(e){return t.treeCache.data[e].data},set:function(a,i,s){t.treeCache.remove(a),t.treeCache.data[a]={_:(new Date).getTime(),data:i},e.isFunction(s)&&s(i)}}},validateTooltips:function(){this.showTooltips&&(this.$toolbar.find(".btn").tooltip(),this.$detail.find(".btn").tooltip())},trigAlert:function(t,a){var i=this.alertFadeDuration;a&&e.isFunction(a)||(a=function(){}),setTimeout(function(){t.fadeOut(i,a())},2*i)},selectNodes:function(){var a=this,i=a.$element.val();0===i.length||t.isEmpty(i)||(a.$tree.find("li").removeClass("kv-selected"),i=i.split(","),e(i).each(function(e,i){t.addCss(a.$tree.find('li[data-key="'+i+'"]'),"kv-selected")}))},raise:function(t,a){var i=e.Event(t);return void 0!==a?this.$element.trigger(i,a):this.$element.trigger(i),!i.isDefaultPrevented()&&!1!==i.result},enableToolbar:function(){this.$toolbar.find("button:not([data-always-disabled])").removeAttr("disabled")},disableToolbar:function(){this.$toolbar.find("button").attr("disabled",!0),this.$toolbar.find(".kv-"+this.btns.createR+":not([data-always-disabled])").removeAttr("disabled")},enable:function(e){this.$toolbar.find(".kv-"+this.btns[e]).removeAttr("disabled")},disable:function(e){this.$toolbar.find(".kv-"+this.btns[e]).attr("disabled",!0)},showAlert:function(e,t,a){var i=this,s=i.$detail,n=s.find(".alert-"+t);s.find(".kv-select-node-msg").remove(),n.removeClass("hide").hide().find("div").remove(),n.append("<div>"+e+"</div>").fadeIn(i.alertFadeDuration,function(){i.trigAlert(n,a)})},removeAlert:function(){this.$detail.find(".alert").addClass("hide")},renderForm:function(a,i,s){var n=this,r=n.$detail,o=i||"",l=s||!1,d=t.hashString(a+n.modelClass+n.isAdmin+o),c=r.find("form"),v=n.actions.manage,h=v&&-1!==v.indexOf("?")?"&":"?";v+=encodeURI(h+t.QUERY_PARAM+"="+d),n.formViewBegin=!0,n.parseCache(),n.removeAlert(),e.ajax({type:"post",dataType:"json",data:t.getAjaxData({id:a,modelClass:n.modelClass,isAdmin:n.isAdmin,formAction:n.formAction,formOptions:n.formOptions,parentKey:o,iconsList:n.iconsList,currUrl:n.currUrl,softDelete:n.softDelete,showFormButtons:n.showFormButtons,showIDAttribute:n.showIDAttribute,showNameAttribute:n.showNameAttribute,multiple:n.multiple,nodeView:n.nodeView,nodeAddlViews:n.nodeAddlViews,nodeViewButtonLabels:n.nodeViewButtonLabels,nodeSelected:n.nodeSelected,breadcrumbs:n.breadcrumbs,allowNewRoots:n.allowNewRoots,treeManageHash:n.treeManageHash}),url:v,cache:!0,beforeSend:function(e,i){n.raise("treeview.beforeselect",[a,e,i])&&(c.length&&c.off().yiiActiveForm("destroy").remove(),r.html(""),t.addCss(r,"kv-loading"))},success:function(e,i,s){r.removeClass("kv-loading"),n.raise("treeview.selected",[a,e,i,s])&&("error"!==e.status?(r.html(e.out),r.find('button[type="reset"]').on("click",function(){n.removeAlert()}),n.removeAlert(),!1===l||t.isEmpty(l.out)||n.showAlert(l.out,l.type)):n.raise("treeview.selecterror",[a,e,i,s])&&r.html('<div class="alert alert-danger" style="margin-top:20px">'+e.out+"</div>"))},error:function(e,t,i){n.raise("treeview.selectajaxerror",[a,e,t,i])},complete:function(e){n.raise("treeview.selectajaxcomplete",[a,e])&&n.validateTooltips()}})},select:function(a,i,s){if(!t.isEmpty(a)){var n,r=i||!1,o=s||!1,l=this.$tree.find('li[data-key="'+a+'"]>.kv-tree-list .kv-node-detail');0!==l.length&&(this.$tree.find(".kv-node-detail").removeClass("kv-focussed"),t.addCss(l,"kv-focussed"),r?this.$tree.find("li.kv-parent").each(function(){var t=e(this);t.has(l).length>0&&t.removeClass("kv-collapsed")}):this.renderForm(a,null,o),(n=l.closest("li")).data("disabled")?this.disableToolbar():this.enableToolbar(),(!n.data("removable")||n.hasClass("kv-inactive")&&this.softDelete||!n.data("removableAll")&&n.hasClass("kv-parent"))&&this.disable("trash"),n.data("movable-u")||this.disable("moveU"),n.data("movable-d")||this.disable("moveD"),n.data("movable-l")||this.disable("moveL"),n.data("movable-r")||this.disable("moveR"),n.data("child-allowed")||this.disable("create"),this.parseParentFlag(a))}},parseParentFlag:function(t){var a,i=this.$detail.find('input[class="kv-parent-flag"]'),s=this.$tree.find('li[data-key="'+t+'"]');i.each(function(){var t=e(this);(a=t.closest("div.checkbox")).removeClass("disabled"),s.hasClass("kv-parent")?t.removeAttr("disabled"):(t.attr("disabled","disabled"),a.addClass("disabled"))})},remove:function(){var a,i,s=this,n=s.$tree.find("li .kv-node-detail.kv-focussed"),r=n.closest("li"),o=s.messages,l=s.$detail,d=l.find("form");0===n.length&&!r.hasClass("kv-empty")||r.hasClass("kv-disabled")||(i=function(e){var t=e?o.emptyNodeRemoved:o.nodeRemoved,i=r.closest("li.kv-parent");r.remove(),a=l.find(".alert"),s.formViewBegin=!1,l.find(".kv-select-node-msg").remove(),a.length&&l.before(a).html("").append(a),i.find("li").length||i.removeClass("kv-parent"),s.showAlert(t,"info",function(){l.append('<h4 class="alert text-center kv-select-node-msg" style="display:none;">'+o.selectNode+"</h4>"),setTimeout(function(){s.formViewBegin||l.find(".kv-select-node-msg").fadeIn(s.alertFadeDuration)},s.alertFadeDuration)})},s.dialogLib.confirm(o.removeNode,function(a){if(a)if(r.hasClass("kv-empty"))i(!0);else{var n=r.data("key");e.ajax({type:"post",dataType:"json",data:t.getAjaxData({id:n,modelClass:s.modelClass,softDelete:s.softDelete,treeRemoveHash:s.treeRemoveHash}),url:s.actions.remove,beforeSend:function(e,a){s.raise("treeview.beforeremove",[n,e,a])&&(d.hide(),s.removeAlert(),t.addCss(l,"kv-loading"))},success:function(e,a,o){if(l.removeClass("kv-loading"),"success"===e.status){if(!s.raise("treeview.remove",[n,e,a,o]))return;if((s.isAdmin||s.showInactive)&&s.softDelete){s.showAlert(e.out,"info"),d.show();var c=s.modelClass.split("\\").pop(),v=d.find('input[name="'+c+'[active]"]');v.val(!1),v.prop("checked",!1),t.addCss(r,"kv-inactive"),r.data("removableAll")&&t.addCss(r.find("li"),"kv-inactive"),t.addCss(r,"kv-inactive")}else i();s.softDelete||s.disableToolbar()}else{if(!s.raise("treeview.removeerror",[n,e,a,o]))return;s.showAlert(e.out,"danger"),d.show()}},error:function(e,t,a){s.raise("treeview.removeajaxerror",[n,e,t,a])},complete:function(e){s.raise("treeview.removeajaxcomplete",[e])}})}}))},move:function(a){var i,s,n,r,o=this,l=o.$tree.find("li .kv-node-detail.kv-focussed"),d=l.closest("li"),c=o.messages,v=o.$detail,h=null,f=function(){};if(0!==l.length&&!d.hasClass("kv-disabled"))if(d.hasClass("kv-empty"))o.dialogLib.alert(c.nodeNewMove);else{switch(a){case"u":if(0===(h=d.prev()).length)return void o.dialogLib.alert(c.nodeTop);f=function(){h.before(d)};break;case"d":if(0===(h=d.next()).length)return void o.dialogLib.alert(c.nodeBottom);f=function(){h.after(d)};break;case"l":if(0===(h=d.parent("ul").closest("li.kv-parent")).length)return void o.dialogLib.alert(c.nodeLeft);(r=h.parent("ul")).hasClass("kv-tree")&&(h=r.children("li:last-child")),f=function(){h.after(d),0===h.find("li").length&&(h.removeClass("kv-parent"),h.find("ul").remove())};break;case"r":if(0===(h=d.prev()).length)return void o.dialogLib.alert(c.nodeRight);f=function(){h.find("li").length>0?h.children("ul").append(d):(t.addCss(h,"kv-parent"),e(document.createElement("ul")).appendTo(h).append(d))};break;default:throw"Invalid move direction '"+a+"'"}i=d.data("key"),s=h.data("key"),e.ajax({type:"post",dataType:"json",data:t.getAjaxData({idFrom:i,idTo:s,modelClass:o.modelClass,dir:a,allowNewRoots:o.allowNewRoots,treeMoveHash:o.treeMoveHash}),url:o.actions.move,beforeSend:function(e,n){o.raise("treeview.beforemove",[a,i,s,e,n])&&t.addCss(o.$treeContainer,"kv-loading-search")},success:function(t,r,l){if(v.length>0&&o.removeAlert(),o.$treeContainer.removeClass("kv-loading-search"),"success"===t.status){if(!o.raise("treeview.move",[a,i,s,t,r,l]))return;f(),"l"===a||"r"===a?(o.treeCache.timeout=0,n=v.length>0&&{out:t.out,type:"success"},o.select(i,!1,n),o.treeCache.timeout=o.cacheTimeout):v.length>0&&o.showAlert(t.out,"success"),o.$tree.find("li.kv-collapsed").each(function(){e(this).has(d).length>0&&e(this).removeClass("kv-collapsed")})}else v.length>0&&o.raise("treeview.moveerror",[a,i,s,t,r,l])&&o.showAlert(t.out,"danger")},error:function(e,t,n){o.$treeContainer.removeClass("kv-loading-search"),o.raise("treeview.moveajaxerror",[a,i,s,e,t,n])&&v.length>0&&(o.removeAlert(),o.showAlert(n,"danger"))},complete:function(e){o.raise("treeview.moveajaxcomplete",[e])}})}},setSelected:function(){var a="",i="";this.$tree.find(".kv-selected").each(function(){var s=e(this),n=t.isEmpty(a)?"":",";a+=n+s.data("key"),i+=n+s.find(">.kv-tree-list .kv-node-label").text()}),this.raise("treeview.change",[a,i])&&(this.$element.val(a),this.raise("change"))},getNewNode:function(){return'<div class="kv-tree-list" tabindex="-1">\n   <div class="kv-node-indicators">&nbsp;</div>\n   <div class="kv-node-detail kv-focussed">\n       <span class="kv-node-label">'+this.messages.emptyNode+"</span>\n   </div>\n</div>"},create:function(){var a,i,s,n,r,o=this,l=o.$tree.find("li .kv-node-detail.kv-focussed"),d=l.closest("li"),c=o.messages;if(d.hasClass("kv-disabled"))o.dialogLib.alert(c.nodeDisabled);else if(0===l.length||d.hasClass("kv-empty"))o.dialogLib.alert(c.invalidCreateNode);else{if(o.$toolbar.find(".kv-"+o.btns.trash).removeAttr("disabled"),(r=d.find("> ul > li.kv-empty")).length>0)return i=r.data("key").replace("empty-",""),o.renderForm(null,i),l.removeClass("kv-focussed"),void t.addCss(r.find(".kv-node-detail"),"kv-focussed");o.raise("treeview.create",[i])&&(r=e(document.createElement("li")).attr({"data-key":"empty-"+d.data("key"),class:"kv-empty"}),s=o.getNewNode(),l.removeClass("kv-focussed"),r.append(s),d.hasClass("kv-parent")?d.children("ul").append(r):(t.addCss(d,"kv-parent"),a=e(document.createElement("ul")).append(r),d.append(a)),o.renderForm(null,d.data("key")),n=r.find(".kv-node-detail"),d.removeClass("kv-collapsed"),r.children(".kv-tree-list").focus(),n.on("click",function(){o.$tree.find(".kv-node-detail").removeClass("kv-focussed"),t.addCss(n,"kv-focussed"),i=r.data("key").replace("empty-",""),o.renderForm(null,i),o.$toolbar.find(".kv-"+o.btns.trash).removeAttr("disabled")}))}},createRoot:function(){var a=this,i=a.$tree.find(".kv-tree"),s=i.children("li.kv-empty");if(a.raise("treeview.createroot")){if(a.$tree.find(".kv-node-detail").removeClass("kv-focussed"),s.length>0)return t.addCss(s.find(".kv-node-detail"),"kv-focussed"),void a.renderForm(null,a.rootKey);var n=a.getNewNode(),r=e(document.createElement("li")).attr({"data-key":"empty-root",class:"kv-empty"});r.html(n),i.append(r),a.renderForm(null,a.rootKey);var o=r.find(".kv-node-detail");t.addCss(o,"kv-focussed"),a.$toolbar.find(".kv-"+a.btns.trash).removeAttr("disabled"),o.on("click",function(){a.$tree.find(".kv-node-detail").removeClass("kv-focussed"),t.addCss(o,"kv-focussed"),a.renderForm(null,a.rootKey),a.$toolbar.find(".kv-"+a.btns.trash).removeAttr("disabled")})}},toggle:function(e){var a=e.closest("li.kv-parent"),i=a.data("key");a.hasClass("kv-collapsed")?this.raise("treeview.expand",[i])&&a.removeClass("kv-collapsed"):this.raise("treeview.collapse",[i])&&t.addCss(a,"kv-collapsed")},toggleAll:function(e,a){if("expand"===e){if(a&&!this.raise("treeview.expandall"))return;return this.$treeContainer.removeClass("kv-collapsed"),void this.$treeContainer.find(".kv-collapsed").removeClass("kv-collapsed")}a&&!this.raise("treeview.collapseall")||(t.addCss(this.$treeContainer.find("li.kv-parent"),"kv-collapsed"),t.addCss(this.$treeContainer,"kv-collapsed"))},check:function(e){var a,i=!0===e,s=i?this.$tree:e.closest("li"),n=i?"":s.data("key"),r=this.multiple&&0!=this.multiple;if(!(s.hasClass("kv-disabled")||i&&!r)){if(s.hasClass("kv-selected")){if(!this.raise("treeview.unchecked",[n]))return;if(s.removeClass("kv-selected"),r)this.cascadeSelectChildren&&s.find("li:not(.kv-disabled)").removeClass("kv-selected");else{if(!this.raise("treeview.change",["",""]))return;this.$tree.find("li:not(.kv-disabled)").removeClass("kv-selected"),this.$element.val(""),this.raise("change")}}else{if(!this.raise("treeview.checked",[n]))return;if(r)this.cascadeSelectChildren&&t.addCss(s.find("li:not(.kv-disabled)"),"kv-selected");else{if(a=s.find(">.kv-tree-list .kv-node-label").text(),!this.raise("treeview.change",[n,a]))return;this.$tree.find("li:not(.kv-disabled)").removeClass("kv-selected"),this.$element.val(n),this.raise("change")}t.addCss(s,"kv-selected")}r&&this.setSelected()}},clear:function(){this.$treeContainer.removeClass("kv-loading-search"),this.$tree.find(".kv-highlight").removeClass("kv-highlight"),this.blurFilter()},parseCache:function(){var t=this;if(!t.enableCache)return!1;e.ajaxPrefilter(function(a,i){if(a.cache){var s=i.beforeSend||e.noop,n=i.success||e.noop,r=i.url;a.cache=!1,a.beforeSend=function(){return s(),!t.treeCache.exist(r)||(n(t.treeCache.get(r)),!1)},a.success=function(e){t.treeCache.set(r,e,n)}}})},focusFilter:function(){this.hideUnmatchedSearchItems&&(this.hasActiveFilter||(this.hasActiveFilter=!0),this.$search.val().length>0&&t.addCss(this.$treeContainer,"kv-active-filter"))},blurFilter:function(){this.clearSearchResults(),this.hideUnmatchedSearchItems&&(this.hasActiveFilter&&(this.hasActiveFilter=!1),this.$treeContainer.removeClass("kv-active-filter"),this.$treeContainer.find(".kv-highlight").removeClass("kv-highlight"),this.$treeContainer.find(".kv-tree-container li.kv-filter-match").removeClass("kv-filter-match"))},clearSearchResults:function(){this.$tree.find(".kv-node-label .kv-search-found").each(function(){var t=e(this);e(document.createElement("span")).appendTo(t).unwrap().remove()})},listen:function(){var a=this;a.$tree.find(".kv-node-toggle").each(function(){var t=e(this);t.on("click",function(){a.toggle(t)})}),a.$tree.find(".kv-node-checkbox:not(.kv-disabled)").each(function(){var t=e(this);t.on("click",function(){a.check(t)})}),a.$treeContainer.find(".kv-root-node-toggle").on("click",function(){a.$treeContainer.hasClass("kv-collapsed")?a.toggleAll("expand",!0):a.toggleAll("collapse",!0)}),a.$treeContainer.find(".kv-root-node-checkbox").on("click",function(){a.check(!0)}),a.$search.on("keyup",function(){var i=e(this).val();a.clear(),a.clearSearchResults(),t.addCss(a.$treeContainer,"kv-loading-search"),t.delay(function(){a.focusFilter(),a.$tree.find("li.kv-filter-match").removeClass("kv-filter-match"),a.toggleAll("collapse",!1),i=t.escapeRegExp(i),a.$tree.find(".kv-node-label").each(function(){var s,n,r=e(this),o=r.text();o.search(new RegExp(i,"i"))<0?r.removeClass("kv-highlight"):(t.addCss(r,"kv-highlight"),s=new RegExp(i,"ig"),n=o.replace(s,function(e){return'<span class="kv-search-found">'+e+"</span>"}),r.html(n),a.$tree.find("li.kv-parent").each(function(){var t=e(this);t.has(r).length>0&&t.removeClass("kv-collapsed")}))}),a.$tree.find(".kv-highlight").parentsUntil(a.$tree.selector,"li").each(function(){t.addCss(e(this),"kv-filter-match")}),a.$treeContainer.removeClass("kv-loading-search"),a.$treeContainer.find(".kv-tree-container").removeClass("kv-collapsed"),a.raise("treeview.search"),0===i.length&&a.blurFilter()},250)}).on("focus",function(){a.focusFilter()}).on("blur",function(){var t=e(this).val();null!==t&&""!==t||a.blurFilter()}),a.$clear.on("click",function(){a.$search.val(""),a.clear()}),a.$tree.find(".kv-node-detail").each(function(){e(this).on("click",function(){var t=e(this),i=t.closest("li"),s=i.data("key");if(a.raise("treeview.select",[s]))return a.$tree.hasClass("kv-tree-input-widget")?(t.removeClass("kv-focussed"),void a.check(i)):void(t.hasClass("kv-focussed")||(a.select(s),a.removeAlert()))})}),a.$toolbar.find(".kv-"+a.btns.create).on("click",function(){a.create()}),a.$toolbar.find(".kv-"+a.btns.createR).on("click",function(){a.createRoot()}),a.$toolbar.find(".kv-"+a.btns.trash).on("click",function(){a.remove()}),a.$toolbar.find(".kv-"+a.btns.moveU).on("click",function(){a.move("u")}),a.$toolbar.find(".kv-"+a.btns.moveD).on("click",function(){a.move("d")}),a.$toolbar.find(".kv-"+a.btns.moveL).on("click",function(){a.move("l")}),a.$toolbar.find(".kv-"+a.btns.moveR).on("click",function(){a.move("r")}),a.$detail.find(".alert").each(function(){var t=e(this);t.hasClass("hide")||(t.hide().fadeIn(1500),a.trigAlert(t))})},expandAll:function(){this.toggleAll("expand")},collapseAll:function(){this.toggleAll("collapse")},checkAll:function(){this.$tree.removeClass("kv-selected"),this.check(!0)},uncheckAll:function(){t.addCss(this.$tree,"kv-selected"),this.check(!0)},checkNode:function(e){var t=this.$tree.find('li[data-key="'+e+'"]');t.length&&(t.removeClass("kv-selected"),this.check(t))},uncheckNode:function(e){var a=this.$tree.find('li[data-key="'+e+'"]');a.length&&(t.addCss(a,"kv-selected"),this.check(a))}},e.fn.treeview=function(t){var i,s,n,r=Array.apply(null,arguments);return r.shift(),this.each(function(){i=e(this),s=i.data("treeview"),n="object"==typeof t&&t,s||(s=new a(this,e.extend({},e.fn.treeview.defaults,n,e(this).data())),i.data("treeview",s)),"string"==typeof t&&s[t].apply(s,r)})},e.fn.treeview.defaults={btns:{},treeId:"",detailId:"",toolbarId:"",wrapperId:"",showTooltips:!0,alertFadeDuration:1e3,cacheTimeout:3e5,showInactive:!1,actions:{manage:"",move:"",delete:""},messages:{emptyNode:"",nodeDisabled:"",invalidCreateNode:"",removeNode:"",nodeRemoved:"",emptyNodeRemoved:"",nodeNewMove:"",nodeTop:"",nodeBottom:"",nodeLeft:"",nodeRight:""},breadcrumbs:{},cascadeSelectChildren:!0,rootKey:"",hideUnmatchedSearchItems:!0},e.fn.treeview.Constructor=a}(window.jQuery);